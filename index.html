<!DOCTYPE html>  
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Car Bookings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 20px; }
    table { width: 100%; }
    /* ✅ Improvement 3: Better readability */
    table.dataTable tbody tr:nth-child(odd) {
      background-color: #f9f9f9;
    }
    table.dataTable tbody td {
      vertical-align: middle;
    }
    .dt-body-center {
      text-align: center;
    }
    
    /* ✅ Improvement 4: Sophisticated loading indicator */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 40px 0;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #666;
      font-size: 16px;
    }
    
    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      border-radius: 4px;
      padding: 15px;
      margin: 20px 0;
    }
    
    .error-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .retry-button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }
    
    .retry-button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h1>Car Bookings</h1>
  
  <!-- ✅ Improvement 4: Enhanced loading indicator -->
  <div id="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading car bookings...</div>
  </div>
  
  <!-- ✅ Improvement 1: Error handling UI -->
  <div id="error-container" style="display: none;"></div>
  
  <table id="bookings" class="display" style="display: none;"></table>
  
  <!-- jQuery + DataTables + Responsive -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    function showError(title, message, showRetry = true) {
      const errorContainer = document.getElementById("error-container");
      errorContainer.innerHTML = `
        <div class="error-message">
          <div class="error-title">${title}</div>
          <div>${message}</div>
          ${showRetry ? '<button class="retry-button" onclick="loadBookings()">Try Again</button>' : ''}
        </div>
      `;
      errorContainer.style.display = 'block';
      document.getElementById("loading").style.display = 'none';
    }
    
    function hideError() {
      document.getElementById("error-container").style.display = 'none';
    }
    
    function showLoading() {
      document.getElementById("loading").style.display = 'flex';
      document.getElementById("bookings").style.display = 'none';
      document.getElementById("footer").style.display = 'none';
      hideError();
    }
    
    function hideLoading() {
      document.getElementById("loading").style.display = 'none';
      document.getElementById("bookings").style.display = 'table';
    }
    
    function loadBookings() {
      showLoading();
      
      Papa.parse('ReportUpcomingWeekVolEmail.txt', {
        download: true,
        header: false,
        delimiter: ",",
        skipEmptyLines: true,
        complete: function(results) {
          try {
            // ✅ Improvement 1: Check for parsing errors
            if (results.errors && results.errors.length > 0) {
              const errorMessages = results.errors.map(error => error.message).join(', ');
              showError(
                'Data Parsing Error',
                `There were issues parsing the booking data: ${errorMessages}`
              );
              return;
            }
            
            let data = results.data;
            
            if (!data || data.length === 0) {
              hideLoading();
              document.querySelector("body").insertAdjacentHTML(
                "beforeend",
                "<p><em>No bookings found in the file.</em></p>"
              );
              return;
            }
            
            const headers = [
              "Date",
              "Day",
              "From",
              "To",
              "Setoff",
              "Pickup",
              "Arrive"
            ];
            
            // ✅ Improvement 1: Validate data structure
            const maxColumns = Math.max(...data.map(row => row.length));
            if (maxColumns > headers.length) {
              console.warn(`Data has ${maxColumns} columns but only ${headers.length} headers defined`);
            }
            
            data = data.map((row, index) => {
              let obj = {};
              headers.forEach((h, i) => {
                obj[h] = row[i] ?? "";
              });
              
              // ✅ Improvement 1: Validate date format
              if (obj["Date"] && obj["Date"].trim()) {
                const dateTest = new Date(obj["Date"]);
                if (isNaN(dateTest.getTime())) {
                  console.warn(`Invalid date format in row ${index + 1}: "${obj["Date"]}"`);
                }
              }
              
              return obj;
            });
            
            const columns = headers.map(h => ({
              title: h,
              data: h,
              type: h === "Date" ? "date" : undefined,
              className: (h === "Pickup" || h === "Arrive" || h === "Setoff") ? "dt-body-center" : ""
            }));
            
            // ✅ Custom filter: hide rows where Date < today
            $.fn.dataTable.ext.search.push(function(settings, rowData) {
              const today = new Date();
              today.setHours(0, 0, 0, 0); // midnight
              const bookingDate = new Date(rowData["Date"]);
              if (isNaN(bookingDate)) return true; // keep rows with invalid dates
              return bookingDate >= today;
            });
            
            // ✅ Register custom date sorting for dd/mm format (but sort by full date)
            $.fn.dataTable.ext.type.order['date-uk-pre'] = function (d) {
              // We need to reconstruct the full date for proper sorting
              // Assume current year for dd/mm format
              const currentYear = new Date().getFullYear();
              const ddmm = d.match(/^(\d{1,2})\/(\d{1,2})$/);
              if (ddmm) {
                const day = parseInt(ddmm[1], 10);
                const month = parseInt(ddmm[2], 10) - 1;
                const fullDate = new Date(currentYear, month, day);
                return fullDate.getTime();
              }
              return 0;
            };
            
            // ✅ Improvement 1: Wrap DataTable initialization in try-catch
            const table = $('#bookings').DataTable({
              data: data,
              columns: columns,
              pageLength: 25,
              scrollX: true, // ✅ Fix: Enable horizontal scrolling
              responsive: {
                details: {
                  type: 'column',
                  target: 'tr'
                }
              },
              columnDefs: [
                // ✅ Fix: Make columns responsive with priorities
                { responsivePriority: 1, targets: [0, 1] }, // Date and Day always visible
                { responsivePriority: 2, targets: [2, 3] }, // From and To second priority
                { responsivePriority: 3, targets: [4, 5, 6] } // Times can be hidden on small screens
              ],
              language: {
                emptyTable: "No bookings match your filters",
                loadingRecords: "Loading bookings…",
                zeroRecords: "No matching bookings found"
              },
              order: [
                [headers.indexOf("Date"), 'asc'],
                [headers.indexOf("Arrive"), 'asc'],
                [headers.indexOf("Pickup"), 'asc'],
                [headers.indexOf("Setoff"), 'asc']
              ]
            });
            
            table.draw();
            hideLoading();
            
          } catch (error) {
            console.error('Error processing booking data:', error);
            showError(
              'Processing Error',
              `An error occurred while processing the booking data: ${error.message}`
            );
          }
        },
        
        // ✅ Improvement 1: Handle Papa Parse errors
        error: function(error) {
          console.error('Papa Parse error:', error);
          showError(
            'File Loading Error',
            'Could not load the booking data file. Please check that "ReportUpcomingWeekVolEmail.txt" exists and is accessible.'
          );
        }
      });
    }
    
    // ✅ Improvement 1: Handle network/file loading errors with timeout
    setTimeout(() => {
      const loadingElement = document.getElementById("loading");
      if (loadingElement && loadingElement.style.display !== 'none') {
        showError(
          'Loading Timeout',
          'The booking data is taking longer than expected to load. This might be due to a network issue or the file being unavailable.'
        );
      }
    }, 10000); // 10 second timeout
    
    // Start loading when page loads (ensure DOM is ready)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadBookings);
    } else {
      loadBookings();
    }
  </script>
</body>
</html>
